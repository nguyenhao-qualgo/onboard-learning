From f7b097e02689d2c9fac4dfa940072c58cbd40191 Mon Sep 17 00:00:00 2001
From: kas User <kas@example.com>
Date: Thu, 8 Jan 2026 19:54:33 +0700
Subject: [PATCH] trigger autoenroll via l4tlauncher

---
 .../Application/L4TLauncher/L4TLauncher.c     | 214 ++++++++++++++++++
 1 file changed, 214 insertions(+)

diff --git a/Silicon/NVIDIA/Application/L4TLauncher/L4TLauncher.c b/Silicon/NVIDIA/Application/L4TLauncher/L4TLauncher.c
index 8b042b04..eeac5bbc 100644
--- a/Silicon/NVIDIA/Application/L4TLauncher/L4TLauncher.c
+++ b/Silicon/NVIDIA/Application/L4TLauncher/L4TLauncher.c
@@ -56,6 +56,215 @@ STATIC ImageEncryptionInfo  EncryptionInfo;
 STATIC VOID   *mRamdiskData = NULL;
 STATIC UINTN  mRamdiskSize  = 0;
 
+#define AUTOENROLL_VAR_NAME   L"AutoEnrollDone"
+#define AUTOENROLL_REL_PATH   L"\\EFI\\BOOT\\AutoEnroll.efi"
+
+STATIC EFI_GUID gAutoEnrollFlagGuid =
+{
+  0x9c2b2f19, 0x0fb7, 0x4bb8,
+  { 0xa0, 0x31, 0x62, 0x3f, 0x48, 0xa8, 0x11, 0x27 }
+};
+
+STATIC
+EFI_STATUS
+AutoEnrollGetFlag (
+  OUT BOOLEAN  *Done
+  )
+{
+  EFI_STATUS  Status;
+  UINT8       Value;
+  UINTN       Size;
+
+  if (Done == NULL) {
+    return EFI_INVALID_PARAMETER;
+  }
+
+  *Done = FALSE;
+  Size  = sizeof (Value);
+
+  Status = gRT->GetVariable (
+                  AUTOENROLL_VAR_NAME,
+                  &gAutoEnrollFlagGuid,
+                  NULL,
+                  &Size,
+                  &Value
+                  );
+  if (EFI_ERROR (Status)) {
+    return EFI_SUCCESS;
+  }
+
+  *Done = (Value != 0);
+  return EFI_SUCCESS;
+}
+
+STATIC
+EFI_STATUS
+AutoEnrollSetFlag (
+  IN BOOLEAN  Done
+  )
+{
+  EFI_STATUS  Status;
+  UINT8       Value;
+  UINT32      Attributes;
+
+  Value      = Done ? 1 : 0;
+  Attributes = EFI_VARIABLE_NON_VOLATILE |
+               EFI_VARIABLE_BOOTSERVICE_ACCESS |
+               EFI_VARIABLE_RUNTIME_ACCESS;
+
+  Status = gRT->SetVariable (
+                  AUTOENROLL_VAR_NAME,
+                  &gAutoEnrollFlagGuid,
+                  Attributes,
+                  sizeof (Value),
+                  &Value
+                  );
+  if (EFI_ERROR (Status)) {
+    ErrorPrint (
+      L"%a: AutoEnrollSetFlag failed: %r\r\n",
+      __FUNCTION__,
+      Status
+      );
+  }
+
+  return Status;
+}
+
+STATIC
+EFI_STATUS
+FindAutoEnrollOnAnyFs (
+  OUT EFI_DEVICE_PATH_PROTOCOL  **FileDevicePathOut
+  )
+{
+  EFI_STATUS                        Status;
+  EFI_HANDLE                       *HandleBuffer;
+  UINTN                             HandleCount;
+  UINTN                             Index;
+  EFI_SIMPLE_FILE_SYSTEM_PROTOCOL  *Sfsp;
+  EFI_FILE_PROTOCOL                *Root;
+  EFI_FILE_PROTOCOL                *TestFile;
+  EFI_DEVICE_PATH_PROTOCOL         *Dp;
+
+  if (FileDevicePathOut == NULL) {
+    return EFI_INVALID_PARAMETER;
+  }
+
+  *FileDevicePathOut = NULL;
+  HandleBuffer       = NULL;
+
+  Status = gBS->LocateHandleBuffer (
+                  ByProtocol,
+                  &gEfiSimpleFileSystemProtocolGuid,
+                  NULL,
+                  &HandleCount,
+                  &HandleBuffer
+                  );
+  if (EFI_ERROR (Status)) {
+    return Status;
+  }
+
+  for (Index = 0; Index < HandleCount; Index++) {
+    Status = gBS->HandleProtocol (
+                    HandleBuffer[Index],
+                    &gEfiSimpleFileSystemProtocolGuid,
+                    (VOID **)&Sfsp
+                    );
+    if (EFI_ERROR (Status)) {
+      continue;
+    }
+
+    Status = Sfsp->OpenVolume (Sfsp, &Root);
+    if (EFI_ERROR (Status)) {
+      continue;
+    }
+
+    Status = Root->Open (
+                    Root,
+                    &TestFile,
+                    AUTOENROLL_REL_PATH,
+                    EFI_FILE_MODE_READ,
+                    0
+                    );
+    if (!EFI_ERROR (Status)) {
+      TestFile->Close (TestFile);
+
+      Dp = FileDevicePath (HandleBuffer[Index], AUTOENROLL_REL_PATH);
+      if (Dp == NULL) {
+        gBS->FreePool (HandleBuffer);
+        return EFI_OUT_OF_RESOURCES;
+      }
+
+      *FileDevicePathOut = Dp;
+      gBS->FreePool (HandleBuffer);
+      return EFI_SUCCESS;
+    }
+  }
+
+  if (HandleBuffer != NULL) {
+    gBS->FreePool (HandleBuffer);
+  }
+
+  return EFI_NOT_FOUND;
+}
+
+STATIC
+EFI_STATUS
+AutoEnrollRunIfNeeded (
+  IN EFI_HANDLE  ImageHandle
+  )
+{
+  EFI_STATUS                 Status;
+  BOOLEAN                    Done;
+  EFI_DEVICE_PATH_PROTOCOL  *AutoDp;
+  EFI_HANDLE                 AutoImage;
+
+  Status = AutoEnrollGetFlag (&Done);
+  if (EFI_ERROR (Status)) {
+    ErrorPrint (L"%a: AutoEnrollGetFlag failed: %r\r\n", __FUNCTION__, Status);
+    return Status;
+  }
+
+  if (Done) {
+    return EFI_SUCCESS;
+  }
+
+  Status = FindAutoEnrollOnAnyFs (&AutoDp);
+  if (EFI_ERROR (Status) || (AutoDp == NULL)) {
+    ErrorPrint (L"%a: FindAutoEnrollOnAnyFs failed: %r\r\n", __FUNCTION__, Status);
+    return Status;
+  }
+
+  AutoImage = NULL;
+
+  Print (L"AutoEnroll: running AutoEnroll.efi on first boot\r\n");
+
+  Status = gBS->LoadImage (
+                  FALSE,
+                  ImageHandle,
+                  AutoDp,
+                  NULL,
+                  0,
+                  &AutoImage
+                  );
+
+  FreePool (AutoDp);
+
+  if (EFI_ERROR (Status)) {
+    ErrorPrint (L"%a: LoadImage AutoEnroll.efi failed: %r\r\n", __FUNCTION__, Status);
+    return Status;
+  }
+
+  Status = gBS->StartImage (AutoImage, NULL, NULL);
+  if (EFI_ERROR (Status)) {
+    ErrorPrint (L"%a: StartImage AutoEnroll.efi failed: %r\r\n", __FUNCTION__, Status);
+    return Status;
+  }
+
+  AutoEnrollSetFlag (TRUE);
+
+  return EFI_SUCCESS;
+}
+
 typedef struct {
   VENDOR_DEVICE_PATH          VendorMediaNode;
   EFI_DEVICE_PATH_PROTOCOL    EndNode;
@@ -2546,6 +2755,11 @@ L4TLauncher (
   VOID                          *Hob;
   TEGRA_PLATFORM_RESOURCE_INFO  *PlatformResourceInfo;
 
+  Status = AutoEnrollRunIfNeeded (ImageHandle);
+  if (EFI_ERROR (Status)) {
+    ErrorPrint (L"%a: AutoEnrollRunIfNeeded failed: %r\r\n", __FUNCTION__, Status);
+  }
+
   Status = gBS->HandleProtocol (ImageHandle, &gEfiLoadedImageProtocolGuid, (VOID **)&LoadedImage);
   if (EFI_ERROR (Status)) {
     ErrorPrint (L"%a: Unable to locate loaded image: %r\r\n", __FUNCTION__, Status);
-- 
2.43.0

